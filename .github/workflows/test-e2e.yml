name: ðŸŽ­ E2E Tests

on:
  push:
    branches: main
  pull_request:
    branches: main
  # schedule:
  #   - cron: '0 3 * * *'  # Run daily at 05:00 AM UTC+2
  workflow_dispatch:

jobs:
  test-e2e:
    name: ðŸŽ­ Run E2E tests
    runs-on: tenki-standard-autoscale

    env:
      PLAYWRIGHT_BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL }}
      PLAYWRIGHT_GITHUB_USERNAME: ${{ secrets.PLAYWRIGHT_GITHUB_USERNAME }}
      PLAYWRIGHT_GITHUB_PASSWORD: ${{ secrets.PLAYWRIGHT_GITHUB_PASSWORD }}


    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ðŸž Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ðŸ§° Install dependencies
        run: bun install

      - name: ðŸŽ­ Install Playwright browsers
        run: bunx playwright install --with-deps chromium
        working-directory: e2e

      - name: ðŸª£ Restore auth state from secret
        id: restore-auth
        run: |
          mkdir -p playwright/.auth/
          if [ -n "${{ secrets.PLAYWRIGHT_AUTH_STATE }}" ]; then
            # Extract hostname from URL using Node.js (matching auth.ts: new URL(baseURL).hostname)
            HOSTNAME=$(node -e "console.log(new URL('${{ secrets.PLAYWRIGHT_BASE_URL }}').hostname.replace(/\./g, '-'))")
            AUTH_FILE="playwright/.auth/user-${HOSTNAME}.json"
            echo "${{ secrets.PLAYWRIGHT_AUTH_STATE }}" | base64 -d > "$AUTH_FILE"
            echo "âœ… Auth state restored from secret to $AUTH_FILE"
            echo "restored=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ” No auth state secret found - will authenticate"
            echo "restored=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¾ Cache auth state
        uses: actions/cache@v4
        id: auth-cache
        with:
          path: playwright/.auth/
          key: auth-state-${{ runner.os }}-${{ secrets.PLAYWRIGHT_BASE_URL }}
          restore-keys: |
            auth-state-${{ runner.os }}-

      - name: ðŸ” Auth status
        run: |
          if [ "${{ steps.restore-auth.outputs.restored }}" == "true" ]; then
            echo "âœ… Using pre-authenticated state from secret"
          elif [ "${{ steps.auth-cache.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… Using cached auth state"
          else
            echo "ðŸ” No auth state found - will authenticate (may require manual verification)"
          fi

      - name: ðŸ§ª Run E2E tests
        run: bun run test:e2e:login

      - name: ðŸ“¤ Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 7

      - name: ðŸ“Š Test summary
        if: always()
        run: |
          echo "## âœ… E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Report" >> $GITHUB_STEP_SUMMARY
          echo "Playwright report available in artifacts: \`playwright-report\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View HTML report: Download \`playwright-report\` artifact and open \`index.html\`" >> $GITHUB_STEP_SUMMARY

